name: Deploy to Lightsail

on:
  push:
    branches: ["main"]

permissions:
  contents: read

env:
  IMAGE_REPO: hsbapch/hsbapch-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1) 브랜치에 따라 프로파일 결정
      - name: Set profile by branch
        run: |
          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            echo "SPRING_PROFILES_ACTIVE=prod" >> $GITHUB_ENV
          elif [ "${GITHUB_REF_NAME}" = "develop" ]; then
            echo "SPRING_PROFILES_ACTIVE=dev" >> $GITHUB_ENV
          else
            echo "SPRING_PROFILES_ACTIVE=local" >> $GITHUB_ENV
          fi

      # 2) Docker Hub 로그인 (PAT 권장)
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 3) 이미지 빌드 & 푸시
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: |
            hsbapch/hsbapch-backend:sha-${{ github.sha }}
            hsbapch/hsbapch-backend:latest


      # 4) Lightsail에 SSH 접속해서 compose 실행
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          script: |
            set -e
            cd /opt/hsbapch-backend

            IMAGE="${{ env.IMAGE_REPO }}:sha-${{ github.sha }}"

            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

            # 서버에 .env 파일을 두지 않는 전제: 실행 시점에만 환경변수 주입
            IMAGE="$IMAGE" \
            SPRING_PROFILES_ACTIVE="${{ env.SPRING_PROFILES_ACTIVE }}" \
            SPRING_DATASOURCE_URL="${{ secrets.DB_URL }}" \
            SPRING_DATASOURCE_USERNAME="${{ secrets.DB_USERNAME }}" \
            SPRING_DATASOURCE_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            docker compose pull

            IMAGE="$IMAGE" \
            SPRING_PROFILES_ACTIVE="${{ env.SPRING_PROFILES_ACTIVE }}" \
            SPRING_DATASOURCE_URL="${{ secrets.DB_URL }}" \
            SPRING_DATASOURCE_USERNAME="${{ secrets.DB_USERNAME }}" \
            SPRING_DATASOURCE_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            docker compose up -d

            docker image prune -f
