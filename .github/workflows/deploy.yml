name: Deploy to Lightsail

on:
  push:
    branches: ["main"]

permissions:
  contents: read

env:
  IMAGE_REPO: hsbapch/hsbapch-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 브랜치에 따라 프로파일 결정
      - name: Set profile by branch
        run: |
          case "${GITHUB_REF_NAME}" in
            main)
              echo "SPRING_PROFILES_ACTIVE=prod" >> $GITHUB_ENV
              ;;
            develop)
              echo "SPRING_PROFILES_ACTIVE=dev" >> $GITHUB_ENV
              ;;
            *)
              echo "SPRING_PROFILES_ACTIVE=local" >> $GITHUB_ENV
              ;;
          esac

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_REPO }}:sha-${{ github.sha }}
            ${{ env.IMAGE_REPO }}:${{ github.ref_name }}

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          port: 22
          script: |
            set -e
            cd /opt/hsbapch-backend

            IMAGE="${{ env.IMAGE_REPO }}:sha-${{ github.sha }}"
            echo "DEPLOY IMAGE=$IMAGE"
            echo "DEPLOY PROFILE=${{ env.SPRING_PROFILES_ACTIVE }}"

            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

            # 프로파일/DB가 확실히 반영되도록 강제 재생성
            IMAGE="$IMAGE" \
            SPRING_PROFILES_ACTIVE="prod" \
            docker compose up -d --pull always --force-recreate

            docker image prune -f
